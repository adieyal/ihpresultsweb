{% block head %}
    {{ block.super }}
    <link rel="stylesheet" type="text/css" href="{{ MEDIA_URL }}css/bootstrap.css"> 
    <!--<link rel="stylesheet" type="text/css" href="{{ MEDIA_URL }}css/table.css">-->
    <style>
        td:first-child {
            text-align: left;
        }

        #twobytwo {
            margin: 20px 100px;
        }

        #twobytwo th {
            font-weight: bold;
        }

        .twobytwo td, .twobytwo th, .twobytwo tr {
            padding: 4px;
            border: solid thin black;
        }

        .twobytwo, #countrybox {
            border: solid thin black;
            float: left;
            margin: 10px;
        }

        #countrybox {
            padding: 5px;
            width: 200px;
            text-align: left;
            height: 200px;
        }

        #countrybox h2 {
            text-decoration: underline;
            font-weight: bold;
        }

        #countrybox li {
            text-align: left;
            list-style: none;
            margin-left: 0;
            padding-left: 1em;
            text-indent: -1em;
        }

    </style>
    <script type='text/javascript' src='{{ MEDIA_URL }}js/jquery-1.7.2.min.js'></script>
    <script type='text/javascript' src='{{ MEDIA_URL }}js/d3.v2.min.js'></script>
    <script type='text/javascript' src='{{ MEDIA_URL }}js/bootstrap.js'></script>
    <script type='text/javascript' src='{{ MEDIA_URL }}js/bootstrap-popover.js'></script>
{% endblock %}

{% block content %}
<div id="twobytwo">
    <div class="row" id="heading"><p class="span12">Two-by-two analysis</p></div>
    <div class="row" id="tables"></div>
    <div class="row">
        <div class="span12" id="countrybox" style="display:none">
            <h2>Countries</h2>
            <ul>
            </ul>
        </div>
    </div>
</div>
<script>

    round = function(v, d) {
        f = Math.pow(10, d);
        return Math.round(v * f) / f;
    }

    show_countrybox = function(container, countries) {
        cbox = container.selectAll("#countrybox").style("display", "block")
        cbox.select("ul")
            .selectAll("li")
            .data(countries)
            .enter()
            .append("li").text(function(d) { return d; });
    }

    hide_countrybox = function(container) {
        cbox = container.selectAll("#countrybox");
        cbox.selectAll("li").remove();
    }

    var build_table = function(json) {
        var container = d3.select("#twobytwo");

        var tablerow = container.select("#tables")
        var table = tablerow.selectAll("div").data(json.indicators)
            .enter()
            .append("div")
            .attr("class", "twobytwo span3")
            .append("table");

        var header1 = table.append("tr");
        var header2 = table.append("tr");
        var strongrow = table.append("tr");
        var weakrow = table.append("tr");

        header1.append("th")
            .attr("colspan", "3")
            .text(function(v) {
                return v.indicator;
            });

        header2.append("th").text("PFM")
        header2.append("th").text("All indicators").attr("class", "hdr_allindicators")
        header2.append("th").text("Not all indicators").attr("class", "hdr_notallindicators")

        $(".hdr_allindicators").popover({
            title : "All indicators",
            content : "The following indicators are included:<br>1G, 2Ga, 6G and 7G"
        });

        $(".hdr_notallindicators").popover({
            title : "Not all indicators",
            content : "Three or fewer of the following indicators' targets have been met:<br>1G, 2Ga, 6G, 7G"
        });


        strongrow.append("th").text("3.5+")
        strongrow.append("td").text(function(v) {
            return round(v.allstrong.value, 2) + " (" + v.allstrong.num_countries + ")";
        })
        .on("mouseover", function(v, i) {
            show_countrybox(container, v.allstrong.countries);
        });

        strongrow.append("td").text(function(v) {
            return round(v.notallstrong.value, 2) + " (" + v.notallstrong.num_countries + ")";
        })
        .on("mouseover", function(v, i) {
            show_countrybox(container, v.notallstrong.countries);
        });

        weakrow.append("th").text("< 3.5");
        weakrow.append("td").text(function(v) {
            return round(v.allweak.value, 2) + " (" + v.allweak.num_countries + ")";
        })
        .on("mouseover", function(v, i) {
            show_countrybox(container, v.allweak.countries);
        });

        weakrow.append("td").text(function(v) {
            return round(v.notallweak.value, 2) + " (" + v.notallweak.num_countries + ")";
        })
        .on("mouseover", function(v, i) {
            show_countrybox(container, v.notallweak.countries);
        });

        table.selectAll("td").on("mouseout", function(v, i) { hide_countrybox(container); });
    }

    var json = '{% url json_two_by_two_analysis %}';
    d3.json(json, function(e){
        build_table(e);
    });
</script>
{% endblock %}
